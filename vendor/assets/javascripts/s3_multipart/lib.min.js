function calc_hash(e,t){var n=e.size,r=1048576,o=0,s=Date.now(),a=new asmCrypto.SHA256,i=new FileReader;i.onload=function(u){if(null===u.target.error){o+=u.loaded,a.process(u.target.result);Math.floor((Date.now()-s)/100);o<n?i.readAsArrayBuffer(e.slice(o,r+o)):(a.finish(),console.log("DONE"),console.log(asmCrypto.bytes_to_hex(a.result)),t(asmCrypto.bytes_to_hex(a.result)))}else console.log("err")},i.readAsArrayBuffer(e.slice(o,r+o))}!function(e){e.S3MP=function(){function t(t){var n,o,s=[],a=this;_.extend(this,t),this.headers=_.fromPairs(_.map(t.headers,function(e,t){return["x-amz-"+t.toLowerCase(),e]})),this.uploadList=[],this.handler={beginUpload:function(){var e=[];return function(t,n){var r=n.key;n.parts.length,void 0===e[r]&&(e[r]=0),e[r]++;for(var o=0;o<t;o++)n.parts[o].activate();a.handler.startProgressTimer(r),a.onStart(n)}}(),onError:function(e,t){a.onError(e,t)},onPartSuccess:function(e,t){var n,r,o;n=e.parts,t.status="complete",o=t.xhr.getResponseHeader("ETag"),e.Etags.push({ETag:o.replace(/\"/g,""),partNum:t.num}),e.uploaded+=t.size,e.inprogress[t.num]=0,r=_.indexOf(n,t),n.splice(r,1),n.length&&-1!==(r=_.findIndex(n,function(e,t,n){if("active"!==e.status)return!0}))&&n[r].activate(),n.length||this.onComplete(e)},onComplete:function(e){var t=_.indexOf(a.uploadList,e);this.clearProgressTimer(t),a.completeMultipart(e,function(t){t.location&&(t.extra_data?a.onComplete(e,t.extra_data):a.onComplete(e))})},onProgress:function(e,t,n,r,o){a.onProgress(e,t,n,r,o)},startProgressTimer:(o=[],function(t){s[t]=e.setInterval(function(){var e,n,r,s,i;void 0===o[t]&&(o[t]=0),n=(e=a.uploadList[t]).size,r=e.uploaded,_.each(e.inprogress,function(t,n){part_available=_.find(e.parts,function(e){return e.num==n}),part_available&&void 0!==t&&(r+=t)}),s=r/n*100,i=r-o[t],o[t]=r,e.handler.onProgress(t,n,r,s,i)},1e3)}),clearProgressTimer:function(t){e.clearInterval(s[t])}},n=this.fileSelector?$(this.fileSelector).get(0).files:this.fileList,_.each(n,function(e,t){var n=new function(e,t,n){function o(){var t,o,s,a,i;t=this,t=this,i=5242880,this.key=n,this.file=e,this.name=e.name,this.size=e.size,this.type=e.type,this.Etags=[],this.inprogress=[],this.uploaded=0,this.status="",this.size>800*i?(console.info("size greater than 4gb"),num_segs=800,a=20):this.size>400*i?(console.info("size greater than 2gb"),num_segs=400,a=15):this.size>200*i?(console.info("size greater than 1gb"),num_segs=200,a=20):this.size>100*i?(num_segs=100,a=7,console.info("size greater than 500mb")):this.size>20*i?(num_segs=20,a=5):this.size>10*i?(num_segs=10,a=2):this.size>2*i?(num_segs=2,a=1):(num_segs=1,a=1),o=_.range(num_segs+1),s=_.map(o,function(t){return Math.round(t*(e.size/num_segs))}),"Unsupported"==t.sliceBlob?this.parts=[new r(e,0,t)]:(this.parts=_.map(s,function(n,o){return new r(t.sliceBlob(e,n,s[o+1]),o+1,t)}),this.parts.pop()),this.init=function(){calc_hash(t.parts[0].blob,function(e){t.parts[0].hash=e,t.initiateMultipart(t,function(e){t.id=e.id,t.upload_id=e.upload_id,t.object_name=e.key,t.parts;t.handler.beginUpload(a,t)})})}}return o.prototype=t,new o}(e,a,t);a.uploadList.push(n),n.init()})}var n;function r(e,t,n){var r,o;r=this,this.size=e.size,this.blob=e,this.num=t,this.upload=n,this.xhr=o=n.createXhrRequest(),o.onload=function(){null===r.xhr.getResponseHeader("ETag")?(console.log("error response Etag null",response),console.log("onError part Etag null",r),n.handler.onError(n,r)):n.handler.onPartSuccess(n,r)},o.onerror=function(e){console.log("error response",e),console.log("onError part",r),n.handler.onError(n,r)},o.upload.onprogress=_.throttle(function(e){e.lengthComputable&&(n.inprogress[t]=e.loaded)},1e3)}return t.prototype.initiateMultipart=function(e,t){var n,r,o;n="/s3_multipart/uploads",r=JSON.stringify({object_name:e.name,content_type:e.type,content_size:e.size,context_data:e.context_data,hash:e.parts[0].hash,headers:this.headers,context:$(this.fileInputElement).data("context"),base_path:$(this.fileInputElement).data("base-path"),uploader:$(this.fileInputElement).data("uploader")}),o=this.createXhrRequest("POST",n),this.deliverRequest(o,r,t)},t.prototype.signPartRequest=function(e,t,n,r,o,s){var a,i,u;content_length=r.size,a="/s3_multipart/uploads/"+e,i=JSON.stringify({object_name:t,upload_id:n,content_length:content_length,hash:o,part_number:r.num}),u=this.createXhrRequest("PUT",a),this.deliverRequest(u,i,s)},t.prototype.completeMultipart=function(e,t){for(var n,r,o,s=4;;)try{return n="/s3_multipart/uploads/"+e.id,r=JSON.stringify({object_name:e.object_name,upload_id:e.upload_id,content_length:e.size,parts:e.Etags}),o=this.createXhrRequest("PUT",n),void this.deliverRequest(o,r,t)}catch(e){if(console.log("Exception while completing: ",e),--s<1)throw e}},t.prototype.deliverRequest=function(e,t,n,r){var o=this;e.onload=function(){if(response=JSON.parse(this.responseText),response.error){if(o.onResponseError){var e=_.find(o.uploadList,{upload_id:response.upload_id});o.onResponseError(e)}return o.onError({name:"ServerResponse",message:response.error})}n(response,r)},e.onerror=function(){console.log("onerror invoke for xhr request under part "+r[0].num+" re activating it."),r[0].activate()},e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content")),e.send(t)},t.prototype.createXhrRequest=(n="function"==typeof XMLHttpRequest.constructor?XMLHttpRequest:"undefined"!=typeof XDomainRequest?XDomainRequest:null,function(e,t,r,o){var s;return o=!0,void 0===Array.prototype.slice.call(arguments)[0]&&(r=null,o=!1),s=new n,o&&s.open(e,t,!0),s.onreadystatechange=r,s}),t.prototype.sliceBlob=function(){try{var e=new Blob}catch(e){return"Unsupported"}return e.slice?function(e,t,n){return e.slice(t,n)}:e.mozSlice?function(e,t,n){return e.mozSlice(t,n)}:e.webkitSlice?function(e,t,n){return e.webkitSlice(t,n)}:"Unsupported"}(),t.prototype._returnUploadObj=function(e){return _.find(this.uploadList,function(t){return t.key===e})},t.prototype.cancel=function(e){var t,n;t=this._returnUploadObj(e),n=_.indexOf(this.uploadList,t),this.uploadList.splice(n,n+1),this.onCancel(e),this.handler.clearProgressTimer(e)},t.prototype.pause=function(e){var t=this._returnUploadObj(e);_.each(t.parts,function(e,t,n){"active"==e.status&&e.pause()}),this.onPause(e),this.handler.clearProgressTimer(e)},t.prototype.resume=function(e){var t=this._returnUploadObj(e);_.each(t.parts,function(e,t,n){"paused"==e.status&&e.activate()}),this.handler.startProgressTimer(e),this.onResume(e)},r.prototype.activate=function(){var e=this;calc_hash(e.blob,function(t){e.upload.signPartRequest(e.upload.id,e.upload.object_name,e.upload.upload_id,e,t,function(n){e.xhr.open("PUT","//bucket-for-income-video-files.s3-eu-west-2.amazonaws.com/"+e.upload.object_name+"?partNumber="+e.num+"&uploadId="+e.upload.upload_id,!0),e.xhr.setRequestHeader("x-amz-date",n.date),e.xhr.setRequestHeader("X-Amz-Content-Sha256",t),e.xhr.setRequestHeader("Authorization",n.authorization),e.xhr.send(e.blob),e.status="active"})})},r.prototype.pause=function(){this.xhr.abort(),this.status="paused"},t}()}(this);